# R 语言

## R基础

- 根据序列长度进行迭代（循环）的时候，`1:seq_along(y)`和`1:length(y)`有什么区别？

  应使用`1:seq_along(y)`。当`length(y) = 0 `时`seq_along(y)`返回`integer(0)`，基于`1:seq_along(y)`的循环会抛错； 而`1:length(y)`表示`1:0`的迭代，可能出现意想不到的结果。参见R for Data Science [@grolemund2019]
  
  >You might not have seen `seq_along()` before. It’s a safe version of the familiar `1:length(l)`, with an important difference: if you have a zero-length vector, `seq_along()` does the right thing
  
  ```{r seq-along, collapse=TRUE, error=TRUE}
  y <- vector("double", 0)
  # 抛错
  seq_along(y)
  sapply(1:seq_along(y), function(x) x + 1)
  
  # 正常计算
  1:length(y)
  sapply(1:length(y), function(x) x + 1)
  ```

- 如果我们在`~/.Rprofile`添加了初始化设置，那么如果当前工作目录中有含有`.Rprofile`的时候（如在github上fork的别人的项目中含有该文件），就会忽略`~/.Rprofile`中的设置。

  解决方法`# ~/.Renviron `中设置site profile变量`R_PROFILE=~/Rprofile.site`，然后把之前`.Rprofile`的设置拷贝到`~/Rprofile.site`即可。这是因为R的启动的时候会在读取`.Rprofile`之前读取`~/Rprofile.site`中的设置。

- 设置Alfred快捷打开rstudio的project

  *Preferences > Features > Default Results > Advanced*，然后把任何`.Rproj`文件拖入窗口，[参考于此](https://whattheyforgot.org/project-oriented-workflow.html#tricks-for-opening-projects)


## 可视化

### 基础图形

- `par("pin")`, `par("usr")`

  `par("pin")`表示当前图形的尺寸用英寸表示(width * height)；`par("usr")`表示当前图形的坐标范围`c(xmin, xmax, ymin, ymax)`

- 颜色代码的可视化，以便观察颜色
  
  `image(1, 1, as.matrix(1), col = "#E64B35")`

### ggplot

- 什么是**individal geom** 和 **collective geom**? 
  基于一行数据进行作图的`geom`称为**individal geom**，如`geom_point`每行数据映射到图形中的一个点；基于多行数据作图的`geom`称为**collective geom**, 如`geom_bar`对多行数据进行统计变换计算其频数，也就是说多行数据映射到图形中的一个**bar**.

- 如何正确使用 **ggplot** `aes(group)`

  见[这篇博客](https://www.choyang.me/zh/post/ggplot-aes-group-var/)

- 修改连续坐标轴的范围
  
  见[这篇博客](https://www.choyang.me/zh/post/ggplot-range-of-continuous-axis/)

- 修改离散坐标的顺序
  见[这篇博文](https://www.choyang.me/zh/post/ggplot-reorder-discrete-axis/)

- 添加文本标注
  
  使用`Inf`或`-Inf`表征在边界添加文本

  ```{r text-annotation-position}
  # 例子源自https://r4ds.had.co.nz/graphics-for-communication.html
  library(ggplot2)
  label <- tibble::tibble(
    displ = Inf,
    hwy = Inf,
    label = "Increasing engine size is \nrelated to decreasing fuel economy."
  )

  ggplot(mpg, aes(displ, hwy)) +
    geom_point() +
    geom_text(aes(label = label), data = label, vjust = "top", hjust = "right")
```

## 字符

### 正则表达式

- 正则表达式字符列表`[]`用法：`[]`中的字符匹配字符本身，如`[.]`匹配.,而不是任意字符，因此可以使用`[.]`代替`\\.`,一些在`[]`内有特殊意义的字符除外，如`-`表示范围，`^`不包含这些字符，`]`结束括号，`\`在字符串中表示转义。

- 正则表达式默认是进行贪婪匹配，即匹配最长字符串，在正则表达式后边加?表示最短匹配

  ```{r collapse=TRUE}
  # 匹配到两个a，然后删除
  sub("a+", "", "aac")
  
  # 匹配到一个a，然后删除
  sub("a+?", "", "aac")
  ```

- 表示重复次数的`*`(任意次)、`?`(0或1次)、`+`(一次以上)优先级较高

  ```{r collapse=TRUE}
  # b出现一次以上
  sub("ab+", "", "ababc")
  
  # ab出现一次以上
  sub("(ab)+", "", "ababc")
  ```

## 可重复性研究

- knitr多个代码块的输出折叠到一个pre块中

  `collapse = TRUE`
  
- 输出为github的markdown格式

  `github_document`产生github的markdown格式，比如`README.Rmd`生成`README.MD`

- knitr 数据较大时设置缓存

  `cache =TRUE`，对于较大数据可能会抛出错误；这时候设置`cache.lazy = FALSE`即可，答案在[这](https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-error-in-rmd-but-not-in-r-script)和[这](https://github.com/yihui/knitr/issues/572)
  
- 代码块中的输出多个图形，怎么输出为一副图形？
  `figure.show`默认为`asis`图形位于产生图形代码后面，多个作图语句就会产生多幅图形，`figure.show='hold'`就代码块结尾显示所有图形，即一个代码块产生一个图形。

### bookdown

- 章节去除编号 章节后面添加 {-}
- 汉话：章节标题汉化，https://bookdown.org/yihui/bookdown/internationalization.html。配置文件`_bookdown.yml`

```
language:
  ui:
  chapter_name: ["第", "章"]
```


>The chapter_name field can be either a character string to be prepended to chapter numbers in chapter titles (e.g., 'CHAPTER '), or an R function that takes the chapter number as the input and returns a string as the new chapter number (e.g., `!expr function(i) paste('Chapter', i))`. If it is a character vector of length 2, the chapter title prefix will be `paste0(chapter_name[1], i, chapter_name[2])`, where `i` is the chapter number. 

### tinytex

- pkgdown编译jss文档的时候出现，`! LaTeX Error: File `ae.sty'not found.` 说明缺少ae包，

```{r eval=FALSE}
tlmgr_search('ae.sty')
# 提示remote repository 版本太旧，2018 < 2019,这时候需要升级texlive
tinytex::reinstall_tinytex()

tlmgr_search('ae.sty')
# ae:
#	    texmf-dist/tex/latex/ae/ae.sty

#安装即可
tlmgr_install('ae')
```
