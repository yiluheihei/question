# R è¯­è¨€ {#rprogramming}

```{r echo=FALSE}
library(magrittr)
```

## å®‰è£…å’Œé…ç½®

### å®‰è£…

- ubuntu å®‰è£ R
  
  å‚è€ƒhttps://cran.r-project.org/bin/linux/ubuntu/README.html
  
  ```sh
  # æ·»åŠ æº ä»¥ 16.04 xenial ä¸ºä¾‹ï¼Œæ ¹æ®è‡ªå·±çš„ubuntuç‰ˆæœ¬æ·»åŠ ç›¸åº”æº
  deb https://cloud.r-project.org/bin/linux/ubuntu xenial-cran35/
  # å¯†åŒ™
  sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
  sudo apt-get update
  sudo apt-get install r-base r-base-dev
  ```

- CentOS å®‰è£… R

  ```sh
  yum install epel-release
  yum install R-core R-core-devel
  ```
  
- å‡çº§ R ç‰ˆæœ¬åè£…, minor ä»¥ä¸Šçš„å‡çº§éœ€è¦é‡æ–°å®‰è£…åŒ…(`x.y.z`ä¸­çš„`y`).

  å‚è€ƒ[è¿™é‡Œ](https://rstats.wtf/maintaining-r.html#how-to-transfer-your-library-when-updating-r).
  
### é…ç½®

- è®¾ç½®cranå’Œbioconductorå›½å†…æº

  å¯ä»¥åœ¨ç”¨æˆ·ä¸»ç›®å½•ä¸‹æ–°å»º`.Rprofile`æ–‡ä»¶ï¼Œæ·»åŠ :
  
  ```r
  # cran mirror
  options(repos = c(CRAN = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
  # bioconductor mirror
  options(BioC_mirror = "http://mirrors.ustc.edu.cn/bioc/")
  ```

### å®‰è£…åŒ…

- centos 7 å®‰è£… hdf5r

  è§[è¿™](https://www.choyang.me/zh/post/centos-7-r-install-hdf5r/)

- cenos 7 å®‰è£… stringr

  stringr ä¾èµ– [stringi](https://cran.r-project.org/web/packages/stringi/), 
  stringi è¦æ±‚ ICU4C >= 55, è€Œcentos 7 ä¸­ icuç‰ˆæœ¬ä¸º50.2ã€‚æˆ‘ä»¬å¯ä»¥ä» stringi çš„
  [github ä»“åº“](https://github.com/gagolews/stringi)ä¸‹è½½æºä»£ç ï¼Œé‡Œé¢åŒ…å«ICUå®‰è£…
  åŒ…ï¼Œç›´æ¥å®‰è£…å³å¯ã€‚
  
  ```r
  wget https://github.com/gagolews/stringi/archive/v1.4.6.tar.gz - O stringi-1.4.6.tar.gz
  install.packages("stringi-1.4.6.tar.gz")
  install.packages("stringr")
  ```

- `install_github()`å®‰è£…åŒ…çš„æ—¶å€™å‡ºç°é”™è¯¯`Error in file.copy(file.path(R.home("doc"), "html", "R.css"), outman)`,
  ç³»ç»Ÿæ˜¯centos
  
  å› ä¸ºå®‰è£… R çš„æ—¶å€™ç¼ºå°‘`file.path(R.home("doc"), "html", "R.css")`ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º,
  å‚è€ƒ[è¿™](https://github.com/r-lib/devtools/issues/2084)
  
  ```R
  if (!file.exists(x)) {
    dir.create(x, recursive=TRUE)
    file.copy(system.file("html/R.css", package="stats"), x)
  }
  ```
  
- ubuntu 20.04 å®‰è£… Cairo å‡ºç°é”™è¯¯, `lib-backend.c:34:10: fatal error: X11/Intrinsic.h: No such file or directory`

  å·²ç»å®‰è£…äº†åŒ…çš„ç³»ç»Ÿä¾èµ– libcairo2-dev, å®‰è£… `libxt-dev`å³å¯ï¼Œå‚è§ [è¿™é‡Œ](https://stackoverflow.com/questions/23642353/error-message-installing-cairo-package-in-r?answertab=active#tab-top)
  
## R åŒ…å¼€å‘

##### 1. githubä¸­æ·»åŠ åŒ…çš„ code coverage {-}
  
  1. ä½¿ç”¨`usethis::use_coverage()`, æ·»åŠ test coverageï¼Œ
  2. è¿è¡Œåä¼šåˆ›å»ºæ–‡ä»¶`codecov.yml`æ§åˆ¶å°ä¼šæ˜¾ç¤ºç±»ä¼¼ä¸‹é¢markerdownæ–‡æœ¬ï¼Œç²˜è´´è‡³
      READMEæ–‡ä»¶æ·»åŠ badage
      
        ```
        [![Codecov test coverage](https://codecov.io/gh/yiluheihei/rlatexmath/branch/master/graph/badge.svg)](https://codecov.io/gh/yiluheihei/rlatexmath?branch=master)
        ```
    
  3. ç”¨githubè´¦å·ç™»å½•[codecov.io](codecov.io), æ·»åŠ è¯¥ä»“åº“è‡³codecovèµ‹äºˆå…¶æƒé™ï¼Œ
      ç„¶åä¼šå¼¹å‡ºä¸€ä¸ªtoken (å¦‚ä¸‹å›¾æ‰€ç¤º)
          
        ```{r codecov-token,echo=FALSE}
        knitr::include_graphics("image/codecov-token.png")
        ```
  4. åˆ©ç”¨`covr::codecov`æ£€æµ‹åŒ…çš„test coverageå¹¶ä¸Šä¼ è‡³codecov
       
        ```r
        covr::codecov(token = "YOUR_TOKEN_GOES_HERE")
        ```
        
##### 2. åŒ…ä¸­ README.md ä¸­ç”¨åˆ°çš„å›¾ç‰‡å­˜æ”¾ä½ç½® {-}

å› ä¸º cran ä¸­ç”Ÿæˆ readme åªå…è®¸æ”¾åœ¨å°‘æ•°æ–‡ä»¶å¤¹ä¸‹ï¼Œå¦‚`man/figures/`
[**pkgdown**](https://github.com/ropensci/rotemplate/issues/19#issuecomment-506315565) 
è·Ÿ cran ä¿æŒä¸€è‡´ã€‚æ‰€ä»¥ README.md ä¸­å›¾ç‰‡å»ºè®®å­˜æ”¾åœ¨`man/figures/`ï¼Œ
å¦‚æœæ˜¯ç”± Rmd æ–‡ä»¶ç”Ÿæˆï¼Œè®¾ç½® knitr å›¾ç‰‡ä¿å­˜è·¯å¾„
`knitr::opts_chunk(fig.path = "man/figures/")`
 
##### 3. å†™ unit test çš„æ—¶å€™å¦‚æœéœ€è¦è¯»å–ç”¨`save()`æˆ–è€…`saveRDS()`ä¿å­˜å¤–éƒ¨æ•°æ®ï¼Œå‡ºç°warning {-}

    Added dependency on R >= 3.5.0 because serialized objects in  serialize/load 
    version 3 cannot be read in older versions of R
    
è¿™æ˜¯å› ä¸º R åœ¨ 3.5.0 ç‰ˆæœ¬åä¿®æ”¹äº†è¿™ä¸¤ä¸ªå‡½æ•°çš„å‚æ•°`version`é»˜è®¤ä¸º`3`, ä¿å­˜æ•°æ®çš„æ—¶å€™è®¾ç½®å‚æ•°`version = 2`å³å¯ã€‚

##### 4. æŒ‰ç…§[r-pkgs](https://r-pkgs.org/data.html#documenting-data)å»ºè®®å†™å¯¼å‡º`data`çš„æ–‡æ¡£ï¼Œcheck çš„æ—¶å€™å‡ºç°warning (`Lazyload: TRUE`) {-}

    > "Variables with usage in documentation object '<data-name>' but not in 
    code: '<data-name>'
  
  å†™æˆå¦‚ä¸‹å½¢å¼è§£å†³é—®é¢˜ï¼Œæ‰‹åŠ¨æŒ‡å®šæ–‡æ¡£çš„`name`ï¼Œæœ€åä¸€è¡Œç”¨`NA`æ›¿ä»£`"<data-name>"`:  
  
  ```R
  #' title
  #'
  #' Description
  #' 
  #' @name <data-name>
  NA
  ```
##### 5. å¸®åŠ©æ–‡æ¡£ä¸­å…¬å¼ {-}

é‡‡ç”¨<code>\\eqn{*latex*}{*ascii*}</code>(è¡Œå†…å…¬å¼), å’Œ 
<code>\\deqn{*latex*}{*ascii*}</code>(ä»¥æ®µè½æ˜¾ç¤ºçš„å…¬å¼). 
å…¶ä¸­ *`latex`* è¡¨ç¤º **LATEX** å…¬å¼, *`ascii`* è¡¨ç¤ºå¸®åŠ©ä¸­æƒ³è¦å±•ç¤ºçš„å…¬å¼,
å¦‚$\frac{\lambda^x e^{-\lambda}}{x!}$, åº”å†™æˆ:

```
\eqn{\frac{\lambda^x e^{-\lambda}}{x!}}{%
     \lambda^x exp(-\lambda)/x!}
```
æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ <code>\\eqn{*latexascii*}</code>, è¡¨ç¤º <code>*latex*</code> å’Œ 
<code>*ascii*</code>è¡¨ç¤ºæ–¹æ³•ç›¸åŒçš„æ—¶å€™å†™ä¸€ä¸ªå‚æ•°å³å¯ã€‚å‚è€ƒ
[è¿™é‡Œ](https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Mathematics).

##### 6. ä¾èµ–å…¶ä»–åŒ…ä¸­çš„æ•°æ® {-}

å‚è€ƒ[è¿™é‡Œ](https://stackoverflow.com/questions/48715141/how-do-i-load-data-from-another-package-from-within-my-package).

1. ç›´æ¥ä½¿ç”¨`::`, `<pkg>::<data>`;
2. å¦‚æœå¤šæ¬¡ç”¨åˆ°è¯¥æ•°æ®ï¼Œå‡å°‘å¤šæ¬¡ä½¿ç”¨`::`çš„å¼€é”€ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶æ•°æ®åˆ°è‡ªå·±çš„åŒ…ä¸­
`<mydata> <- <pkg>::<data>`;
3. å¦‚æœå¯ä»¥ä¿®æ”¹æºæ•°æ®çš„åŒ…ï¼Œå¯ä»¥å¯¼å‡ºæ•°æ®, åœ¨ `<pkg>` çš„ `NAMESPACE` ä¸­æ·»åŠ 
`@export(<data>)`, æˆ–`roxygen2`æ·»åŠ `@export`å­—æ®µã€‚ç„¶å`@importFrom <pkg> <data>`
å°±å¯ç›´æ¥ä½¿ç”¨æ•°æ®ã€‚(ç„¶è€Œè€å“ˆçš„ [r-pkgs](https://r-pkgs.org/data.html#documenting-data)
ä¸­è¯´:

    > Never \@export a data set.


##### 7. Macå‡çº§ Big SuråR åŒ…å¼€å‘ç¯å¢ƒè¢«ç ´åï¼Œæ”¹è¿›æ–¹æ³• {-}

å‚è€ƒ[è¿™é‡Œ](https://stackoverflow.com/questions/65251887/clang-7-error-linker-command-failed-with-exit-code-1-for-macos-big-sur)

1. å‡çº§ xcode
2. ä»è¿™é‡Œå®‰è£…gfortranï¼šhttps://github.com/fxcoudert/gfortran-for-macOS
3. ä¿®æ”¹`~/.R/Makevars`

```sh
# å¤‡ä»½~/.R/Makevars, å¦‚æœæ²¡æœ‰ç›´æ¥æ–°å»ºå³å¯
mv ~/.R/Makevars ~/.R/Makevars.bak

vi ~/.R/Makevars # æ·»åŠ 
FLIBS=-L/usr/local/gfortran/lib/gcc/x86_64-apple-darwin19/10.2.0 -L/usr/local/gfortran/lib -lgfortran -lquadmath -lm
CXX1X=/usr/local/gfortran/bin/g++
CXX98=/usr/local/gfortran/bin/g++
CXX11=/usr/local/gfortran/bin/g++
CXX14=/usr/local/gfortran/bin/g++
CXX17=/usr/local/gfortran/bin/g++

LLVM_LOC = /usr/local/opt/llvm
CC=/usr/local/gfortran/bin/gcc -fopenmp
CXX=/usr/local/gfortran/bin/g++ -fopenmp
CFLAGS=-g -O3 -Wall -pedantic -std=gnu99 -mtune=native -pipe
CXXFLAGS=-g -O3 -Wall -pedantic -std=c++11 -mtune=native -pipe
LDFLAGS=-L/usr/local/opt/gettext/lib -L$(LLVM_LOC)/lib -Wl,-rpath,$(LLVM_LOC)/lib
CPPFLAGS=-I/usr/local/opt/gettext/include -I$(LLVM_LOC)/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include
```

## Rstudio

- rstudio git é€‰æ‹©æ‰€æœ‰æ–‡ä»¶addå¹¶commit

  åœ¨commitç•Œé¢ï¼Œ`ctrl/command + A`å…¨é€‰,ç„¶åå›è½¦å³å¯ï¼Œå‚è€ƒ[è¿™é‡Œ
  ](https://stackoverflow.com/a/33913671/3993246)

- ubuntu rstudioä¸æ”¯æŒä¸­æ–‡
  
  è¿™æ˜¯å› ä¸º rstudio è‡ªå¸¦çš„QT5ä¸æ”¯æŒ fctix (æœç‹—æ‹¼éŸ³å°±æ˜¯ä¾èµ–fctix)ï¼Œè®¾ç½® rstuido ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„QTå³å¯ï¼Œæ­¥éª¤å¦‚ä¸‹
  ```
  # 1.ç³»ç»Ÿè‡ªå¸¦ qt çš„ fctix æ’ä»¶é“¾æ¥åˆ° rstudio ç›¸åº”æ–‡ä»¶å¤¹ä¸‹
  sudo ln -s /usr/lib/$(dpkg-architecture -qDEB_BUILD_MULTIARCH)/qt5/plugins/platforminputcontexts/libfcitxplatforminputcontextplugin.so /usr/lib/rstudio/plugins/platforminputcontexts/
  ```
  é‡å¯ Rstudio å³å¯


### snippet

åœ¨ç¼–å†™è„šæœ¬çš„æ—¶å€™ï¼Œåœ¨è„šæœ¬å¼€å§‹å†™ä¸Šè¯¥è„šæœ¬çš„ä¿¡æ¯ï¼ˆå¦‚ä½œè€…ï¼Œæ—¶é—´ï¼Œè„šæœ¬è¯´æ˜ï¼‰

```r
snippet header_script
	################################################################################
	## Description: 
	## Author: 
	## Create Time: `r paste(date())`
	## Updated Time: 
	################################################################################
```

è„šæœ¬çš„åˆ†æ®µæ³¨é‡Š, æè¿°è¯¥æ®µä»£ç çš„ä½œç”¨

```r
snippet header_section
	################################################################################
	################################################################################
```



### Rstudio å¸¸ç”¨å¿«æ·é”®

#### Navigating code (ä»£ç å¯¼èˆª)

##### è·³è½¬åˆ°projectä¸­çš„æ–‡ä»¶/å‡½æ•°(å®šä¹‰)

- `ctrl + .`, åœ¨å¼¹å‡ºæ¡†ä¸­è¾“å…¥æ–‡ä»¶åæˆ–è€…å‡½æ•°å, ä¹Ÿå¯ä»¥åœ¨å·¥å…·æ çš„`Go to File/Function` æœç´¢æ¡†ä¸­è¾“å…¥è¦æœç´¢çš„æ–‡ä»¶åæˆ–è€…å‡½æ•°å
- `F2`
- æŒ‰ä½`ctrl`, ç‚¹å‡»å·¦é”®

##### æºæ–‡ä»¶å¯¼èˆª

- è·³è½¬åˆ°æŒ‡å®šè¡Œï¼Œ `Alt+Shift+G` (Mac: `Option+Shift+Cmd+G`).
- ç‚¹å‡»æºä»£ç ç¼–è¾‘å™¨(source editor)ä¸‹æ–¹çš„çŠ¶æ€æ ä»å‡½æ•°åˆ—è¡¨ä¸­é€‰æ‹©å‡½æ•°ä¼šè·³è½¬åˆ°è¯¥å‡½æ•°
çš„æºç .

##### å‰è¿›å’Œåé€€

`Ctrl+F9/Ctrl+F10` (Mac: `Cmd+F9/Cmd+F10`)æˆ–è€…æ˜¯æºä»£ç ç¼–è¾‘å™¨ä¸Šæ–¹å·¥å…·æ æœ€å·¦è¾¹çš„æ–¹å‘
ç®­å¤´ã€‚é€‚ç”¨äºä»¥ä¸‹æƒ…å†µ:

- ä¸åŒsourceæ–‡ä»¶ä¹‹é—´çš„åˆ‡æ¢
- è·³è½¬åˆ°å‡½æ•°å®šä¹‰å¤„
- è·³è½¬åˆ°æŒ‡å®šè¡Œ

#### Code folding (ä»£ç æŠ˜å ) 

ä»¥ä¸‹å‡ ç±»ä»£ç å¯ä»¥æŠ˜å :å¤§æ‹¬å·`{}`å†…çš„ä»£ç å—(å¦‚å‡½æ•°æˆ–è€…æ¡ä»¶è¯­å¥); Rmarkdown ä¸­ä»£ç 
å— (code chunks) å’Œæ ‡é¢˜,åŠä»£ç æ®µ (code section);ä»»ä½•ä»¥å››ä¸ªä»¥ä¸Šçš„`-`æˆ–`=`æˆ–`#`å­—
ç¬¦ä¸ºç»“å°¾çš„æ³¨é‡Šè¡Œ(æ³¨é‡Šè¡Œä¸­å¼€å§‹`#`çš„ä¸ªæ•°å¯ä»¥ä¸ºå¤šä¸ª)ã€‚

```
# Section One ---------------------------------
 
# Section Two =================================
 
### Section Three ############################# 
```

- æŠ˜å , `Alt+L`
- å±•å¼€, `Shit+Alt+L`
- å…¨éƒ¨æŠ˜å , `Alt+O`
- å…¨éƒ¨å±•å¼€, `Shit+Alt+O`
- æ’å…¥ä»£ç å—, `Ctrl+Shit+R` (Mac: `Cmd+Shift+R`)
- ä»£ç å—è·³è½¬, `Shit+Alt+J`


## R åŸºç¡€

- æ ¹æ®åºåˆ—é•¿åº¦è¿›è¡Œè¿­ä»£ï¼ˆå¾ªç¯ï¼‰çš„æ—¶å€™ï¼Œ`1:seq_along(y)`å’Œ`1:length(y)`æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

  åº”ä½¿ç”¨`1:seq_along(y)`ã€‚å½“`length(y) = 0 `æ—¶`seq_along(y)`è¿”å›`integer(0)`ï¼ŒåŸºäº`1:seq_along(y)`çš„å¾ªç¯ä¼šæŠ›é”™ï¼› è€Œ`1:length(y)`è¡¨ç¤º`1:0`çš„è¿­ä»£ï¼Œå¯èƒ½å‡ºç°æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚å‚è§R for Data Science [@grolemund2019]
  
  >You might not have seen `seq_along()` before. Itâ€™s a safe version of the familiar `1:length(l)`, with an important difference: if you have a zero-length vector, `seq_along()` does the right thing
  
  ```{r seq-along, collapse=TRUE, error=TRUE}
  y <- vector("double", 0)
  # æŠ›é”™
  seq_along(y)
  sapply(1:seq_along(y), function(x) x + 1)
  
  # æ­£å¸¸è®¡ç®—
  1:length(y)
  sapply(1:length(y), function(x) x + 1)
  ```

- å¦‚æœæˆ‘ä»¬åœ¨`~/.Rprofile`æ·»åŠ äº†åˆå§‹åŒ–è®¾ç½®ï¼Œé‚£ä¹ˆå¦‚æœå½“å‰å·¥ä½œç›®å½•ä¸­æœ‰å«æœ‰`.Rprofile`çš„æ—¶å€™ï¼ˆå¦‚åœ¨githubä¸Šforkçš„åˆ«äººçš„é¡¹ç›®ä¸­å«æœ‰è¯¥æ–‡ä»¶ï¼‰ï¼Œå°±ä¼šå¿½ç•¥`~/.Rprofile`ä¸­çš„è®¾ç½®ã€‚

  è§£å†³æ–¹æ³•`# ~/.Renviron `ä¸­è®¾ç½®site profileå˜é‡`R_PROFILE=~/Rprofile.site`ï¼Œç„¶åæŠŠä¹‹å‰`.Rprofile`çš„è®¾ç½®æ‹·è´åˆ°`~/Rprofile.site`å³å¯ã€‚è¿™æ˜¯å› ä¸ºRçš„å¯åŠ¨çš„æ—¶å€™ä¼šåœ¨è¯»å–`.Rprofile`ä¹‹å‰è¯»å–`~/Rprofile.site`ä¸­çš„è®¾ç½®ã€‚

- è®¾ç½®Alfredå¿«æ·æ‰“å¼€rstudioçš„project

  *Preferences > Features > Default Results > Advanced*ï¼Œç„¶åæŠŠä»»ä½•`.Rproj`æ–‡ä»¶æ‹–å…¥çª—å£ï¼Œ[å‚è€ƒäºæ­¤](https://whattheyforgot.org/project-oriented-workflow.html#tricks-for-opening-projects)
  
- å®‰è£…rlangçš„æ—¶å€™å‡ºç°é”™è¯¯`å¤åˆ¶ C:\R-3.6.0\library\00LOCK-rlang\00new\rlang\libs\x64\rlang.dllåˆ° C:\R-3.6.0\library\rlang\libs\x64\rlang.dll æ—¶å‡ºäº†é—®é¢˜ï¼šPermission denied`

  å› ä¸ºå¦‚æœRåŒ…å¦‚æœåŒ…å«c++/c/Fortranä»£ç ï¼ˆå¦‚rlangï¼‰ï¼Œå¦‚æœå·²ç»åŠ è½½äº†è¿™ç§åŒ…ï¼Œåœ¨å¯¹å…¶è¿›è¡Œå‡çº§æˆ–è€…é‡è£…
  çš„æ—¶å€™å°±ä¼šå‡ºç°ç±»ä¼¼ä¸Šè¿°é”™è¯¯ã€‚å…³æ‰åŠ è½½è¿™äº›åŒ…çš„Rï¼Œæ‰èƒ½ç»§ç»­é‡è£…æˆ–å‡çº§ã€‚

- å‡ºç°é”™è¯¯:`C stack usage xxxx is too close to the limit`

  å¯èƒ½æ˜¯å› ä¸ºè°ƒç”¨å‡½æ•°å­˜åœ¨æ— é™å¾ªç¯çš„é€’å½’è°ƒç”¨
  
  ```r
  foo <- function(...) {
    foo(...)
  }
  ```

- `data.frame`ä½œä¸ºlistçš„ä¸€ä¸ªå…ƒç´ 
  
  åœ¨å†™å‡½æ•°çš„æ—¶å€™æœ‰æ—¶å€™éœ€è¦åˆ©ç”¨å‚æ•°åˆ—è¡¨(åˆ—è¡¨çš„åç§°è¡¨ç¤ºå‚æ•°å)åŠ `do.call()`æ¥è°ƒç”¨
  æ‰§è¡Œå‡½æ•°ã€‚ä¸€èˆ¬å½¢å¦‚`c(list(arg1=value1, arg2=value2), arg3=value3)`,
  å¦‚æœæœ‰å‚æ•°çš„ç±»åˆ«æ˜¯`data.frame`çš„è¯(value3)ï¼Œå› ä¸º`data.frame`å®é™…ä¸Šä¹Ÿæ˜¯åˆ—è¡¨, 
  è¿™æ ·`data.frame`çš„æ¯ä¸€åˆ—éƒ½ä¼šæˆä¸ºåˆ—è¡¨çš„ä¸€ä¸ªå…ƒç´ ã€‚ä¸ºäº†ä¿è¯`data.frame`ä½œä¸ºåˆ—è¡¨çš„
  ä¸€ä¸ªå…ƒç´ ï¼Œå¯¹è¯¥å‚æ•°åœ¨æ„å»ºå‚æ•°åˆ—è¡¨çš„æ—¶å€™è¦æ˜¾å¼çš„ä½¿ç”¨`list(df)`,
  `c(list(arg1=value1, arg2=value2), arg3=list(value3))`
  
- `switch`ä¸­åŒ¹é…`NA`, ä½¿ç”¨ç”¨åå¼•å·

   ```r
   swithc(
       var, 
       var1 = ...,
       var2 = ...,
       `NA` = ...
  )
   ```

## tidyverse æ•°æ®åˆ†æ

- `data.frame` è½¬ç½®(transpose)
  
  tidyverse ä¸­ é»˜è®¤æ“ä½œæ•°æ®ç»“æ„ä¸º `tibble`, ç”¨äºæ›¿ä»£ R ä¸­`data.frame`ï¼Œ`tibble`
  é»˜è®¤æ²¡æœ‰è¡Œåã€‚ä¸‹é¢å¯¹ç”¨`t()`å’Œ tidyr æ–¹æ³•è½¬ç½®ä½œæ¯”è¾ƒï¼š
  
  ç”¨`t()`å‡½æ•°
  
  ```{r t-transpose}
  # æœ‰è¡Œåçš„æ•°æ®
  df <- data.frame(a = 1:3, b = 4:6)
  row.names(df) <- paste0("r", 1:3)
  
  # as.data.frame(), ä¿æŒè¡Œåå’Œåˆ—å
  t(df) %>% as.data.frame()
  
  # as_tibble, é»˜è®¤åˆ é™¤è¡Œå
  t(df) %>% tibble::as_tibble()
  # å¯ä»¥ç”¨`rowname = NA`ä¿æŒè¡Œå, å·¦ä¸Šè§’æœ‰ä¸ª`*`è¡¨ç¤ºè¿™ä¸ªtibbleæœ‰è¡Œå
  t(df) %>% tibble::as_tibble(rownames = NA)
  ```
  
  ç”¨ tidyr ä¸­å‡½æ•°
  
  ```{r tidyr-transpose}
  # ä¿æŒè¡Œåå’Œåˆ—å, column_to_rownamesç”¨äºè®¾ç½®è¡Œåï¼Œè¿”å›data.frame
  tibble::rownames_to_column(df) %>% 
    tidyr::pivot_longer(-rowname) %>% 
    tidyr::pivot_wider(names_from = "rowname", values_from = "value") %>% 
    tibble::column_to_rownames("name")
  ```
  
  æ­¤å¤–è¿˜å¯ä»¥ä½¿ç”¨ `purrr::transpose`
  
  ```{r purrr-transpose}
  # è¡Œååˆ—åéƒ½ä¸¢å¤±ï¼Œtranspose å»é™¤äº†åŸæœ‰è¡Œå
  purrr::transpose(df) %>%
    purrr::map(unlist) %>% 
    dplyr::bind_cols()
  ```

## å¯è§†åŒ– {#visualization}

### åŸºç¡€å›¾å½¢ {#base-plot}

- `par("pin")`, `par("usr")`

  `par("pin")`è¡¨ç¤ºå½“å‰å›¾å½¢çš„å°ºå¯¸ç”¨è‹±å¯¸è¡¨ç¤º(width * height)ï¼›`par("usr")`è¡¨ç¤ºå½“å‰å›¾å½¢çš„åæ ‡èŒƒå›´`c(xmin, xmax, ymin, ymax)`

- é¢œè‰²ä»£ç çš„å¯è§†åŒ–ï¼Œä»¥ä¾¿è§‚å¯Ÿé¢œè‰²
  
  - `image(1, 1, as.matrix(1), col = "#E64B35")`
  - `scales::show_col("#E64B35")`

### ggplot

- ä»€ä¹ˆæ˜¯**individal geom** å’Œ **collective geom**? 
  åŸºäºä¸€è¡Œæ•°æ®è¿›è¡Œä½œå›¾çš„`geom`ç§°ä¸º**individal geom**ï¼Œå¦‚`geom_point`æ¯è¡Œæ•°æ®æ˜ å°„åˆ°å›¾å½¢ä¸­çš„ä¸€ä¸ªç‚¹ï¼›åŸºäºå¤šè¡Œæ•°æ®ä½œå›¾çš„`geom`ç§°ä¸º**collective geom**, å¦‚`geom_bar`å¯¹å¤šè¡Œæ•°æ®è¿›è¡Œç»Ÿè®¡å˜æ¢è®¡ç®—å…¶é¢‘æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šè¡Œæ•°æ®æ˜ å°„åˆ°å›¾å½¢ä¸­çš„ä¸€ä¸ª**bar**.

- å¦‚ä½•æ­£ç¡®ä½¿ç”¨ **ggplot** `aes(group)`

  è§[è¿™ç¯‡åšå®¢](https://www.choyang.me/zh/post/ggplot-aes-group-var/)

- ä¿®æ”¹è¿ç»­åæ ‡è½´çš„èŒƒå›´
  
  è§[è¿™ç¯‡åšå®¢](https://www.choyang.me/zh/post/ggplot-range-of-continuous-axis/)

- åæ ‡è½´labelç§»åŠ¨åˆ°å›¾å½¢å†…éƒ¨

  è§[æ­¤](https://www.choyang.me/zh/post/moving-axis-label-left-justified-inside-plot-area/)

- ä¿®æ”¹ç¦»æ•£åæ ‡çš„é¡ºåº
  è§[è¿™ç¯‡åšæ–‡](https://www.choyang.me/zh/post/ggplot-reorder-discrete-axis/)

- æ·»åŠ æ–‡æœ¬æ ‡æ³¨
  
  ä½¿ç”¨`Inf`æˆ–`-Inf`è¡¨å¾åœ¨è¾¹ç•Œæ·»åŠ æ–‡æœ¬

  ```{r text-annotation-position}
  # ä¾‹å­æºè‡ªhttps://r4ds.had.co.nz/graphics-for-communication.html
  library(ggplot2)
  label <- tibble::tibble(
    displ = Inf,
    hwy = Inf,
    label = "Increasing engine size is \nrelated to decreasing fuel economy."
  )

  ggplot(mpg, aes(displ, hwy)) +
    geom_point() +
    geom_text(aes(label = label), data = label, vjust = "top", hjust = "right")
  ```

- å›¾å½¢æ·»åŠ è¾¹æ¡†

  è®¾ç½®`theme(plot.background = element_rect())`
  
  ```{r round-rect}
  ggplot(mtcars, aes(wt, mpg)) +
    geom_point() +
    theme(plot.background = element_rect(color = "black"))
  ```

- ç­‰é«˜çº¿å›¾`geom_contour()`è‡ªå®šä¹‰levels
  
  æ‰‹åŠ¨æŒ‡å®šå‚æ•°`breaks`(å¸®åŠ©æ–‡æ¡£ä¸­æ‰¾ä¸åˆ°è¯¥å‚æ•°è¯´æ˜)ï¼Œå‚è€ƒ[æ­¤](https://stackoverflow.com/questions/19658088/custom-levels-in-ggplot2-contour-plot).
  
- ggplotä¸­æ–‡å­—ä½“

  [è§æ­¤](https://www.choyang.me/zh/post/ggplot-chinese-font/)
  
- ggplotåˆ†é¢æ·»åŠ tag (å¦‚A,B, C)ï¼Œå¯å‚è€ƒ[æ­¤é—®é¢˜](https://community.rstudio.com/t/how-to-automatically-add-text-annotations-or-tags-outside-of-faceted-plots/13700)

  ```{r facet-tag}
  p <- ggplot(mpg, aes(displ, hwy)) + 
    geom_point() +
    facet_wrap(vars(class))
  egg::tag_facet_outside(p)
  ```
## å­—ç¬¦ {#char}

### æ­£åˆ™è¡¨è¾¾å¼ {#rexpr}

- æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦åˆ—è¡¨`[]`ç”¨æ³•ï¼š`[]`ä¸­çš„å­—ç¬¦åŒ¹é…å­—ç¬¦æœ¬èº«ï¼Œå¦‚`[.]`åŒ¹é….,è€Œä¸æ˜¯ä»»æ„å­—ç¬¦ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨`[.]`ä»£æ›¿`\\.`,ä¸€äº›åœ¨`[]`å†…æœ‰ç‰¹æ®Šæ„ä¹‰çš„å­—ç¬¦é™¤å¤–ï¼Œå¦‚`-`è¡¨ç¤ºèŒƒå›´ï¼Œ`^`ä¸åŒ…å«è¿™äº›å­—ç¬¦ï¼Œ`]`ç»“æŸæ‹¬å·ï¼Œ`\`åœ¨å­—ç¬¦ä¸²ä¸­è¡¨ç¤ºè½¬ä¹‰ã€‚

- æ­£åˆ™è¡¨è¾¾å¼é»˜è®¤æ˜¯è¿›è¡Œè´ªå©ªåŒ¹é…ï¼Œå³åŒ¹é…æœ€é•¿å­—ç¬¦ä¸²ï¼Œåœ¨æ­£åˆ™è¡¨è¾¾å¼åè¾¹åŠ ?è¡¨ç¤ºæœ€çŸ­åŒ¹é…

  ```{r collapse=TRUE}
  # åŒ¹é…åˆ°ä¸¤ä¸ªaï¼Œç„¶ååˆ é™¤
  sub("a+", "", "aac")
  
  # åŒ¹é…åˆ°ä¸€ä¸ªaï¼Œç„¶ååˆ é™¤
  sub("a+?", "", "aac")
  ```

- è¡¨ç¤ºé‡å¤æ¬¡æ•°çš„`*`(ä»»æ„æ¬¡)ã€`?`(0æˆ–1æ¬¡)ã€`+`(ä¸€æ¬¡ä»¥ä¸Š)ä¼˜å…ˆçº§è¾ƒé«˜

  ```{r collapse=TRUE}
  # bå‡ºç°ä¸€æ¬¡ä»¥ä¸Š
  sub("ab+", "", "ababc")
  
  # abå‡ºç°ä¸€æ¬¡ä»¥ä¸Š
  sub("(ab)+", "", "ababc")
  ```

## å¯é‡å¤æ€§ç ”ç©¶ {#reproducible-research}

### Rmarkdown - Knitr

- Rmarkdown è¾“å‡º pdf æ”¯æŒä¸­æ–‡
  
  ä½¿ç”¨[rticles](https://github.com/rstudio/rticles)åŒ…, åœ¨ `yaml` å¤´æ–‡ä»¶ä¸­æŒ‡å®š
  è¾“å‡ºæ ¼å¼ä¸º`rticles::ctex`.  å‚è€ƒ[è¿™é‡Œ](https://github.com/rstudio/rticles/blob/master/inst/rmarkdown/templates/ctex/skeleton/skeleton.Rmd)
  
  ```
  documentclass: ctexart
  output:
    rticles::ctex
  ```

- knitrå¤šä¸ªä»£ç å—çš„è¾“å‡ºæŠ˜å åˆ°ä¸€ä¸ªpreå—ä¸­

  `collapse = TRUE`
  
- è¾“å‡ºä¸ºgithubçš„markdownæ ¼å¼

  `github_document`äº§ç”Ÿgithubçš„markdownæ ¼å¼ï¼Œæ¯”å¦‚`README.Rmd`ç”Ÿæˆ`README.MD`

- knitr æ•°æ®è¾ƒå¤§æ—¶è®¾ç½®ç¼“å­˜

  `cache =TRUE`ï¼Œå¯¹äºè¾ƒå¤§æ•°æ®å¯èƒ½ä¼šæŠ›å‡ºé”™è¯¯ï¼›è¿™æ—¶å€™è®¾ç½®`cache.lazy = FALSE`å³å¯ï¼Œç­”æ¡ˆåœ¨[è¿™](https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-error-in-rmd-but-not-in-r-script)å’Œ[è¿™](https://github.com/yihui/knitr/issues/572)
  
- ä»£ç å—ä¸­çš„è¾“å‡ºå¤šä¸ªå›¾å½¢ï¼Œæ€ä¹ˆè¾“å‡ºä¸ºä¸€å‰¯å›¾å½¢ï¼Ÿ

  `figure.show`é»˜è®¤ä¸º`asis`å›¾å½¢ä½äºäº§ç”Ÿå›¾å½¢ä»£ç åé¢ï¼Œå¤šä¸ªä½œå›¾è¯­å¥å°±ä¼šäº§ç”Ÿå¤šå¹…å›¾å½¢ï¼Œ`figure.show='hold'`å°±ä»£ç å—ç»“å°¾æ˜¾ç¤ºæ‰€æœ‰å›¾å½¢ï¼Œå³ä¸€ä¸ªä»£ç å—äº§ç”Ÿä¸€ä¸ªå›¾å½¢ã€‚

- Rmarkdown ä¸­ä»£ç å—å†…æ–œä½“(æˆ–å…¶ä»– markdown æ ‡è®°è¯­æ³•)

  æŠŠ ä¸€èˆ¬çš„ markdown æ ‡è®°æ”¾åœ¨ä»£ç å¤–å›´ï¼Œå¦‚``*`æ–œä½“ä»£ç `*``, æ˜¾ç¤ºä¸º*`æ–œä½“ä»£ç `*ã€‚
  å¦‚æœæ˜¯æ­£å¸¸å­—ä½“å’Œæ–œä½“æ··åˆå€ŸåŠ©`<code>`å…ƒç´ : `<code>æ­£å¸¸*æ–œä½“*</code>`ï¼Œæ˜¾ç¤ºä¸º
  <code>æ­£å¸¸*æ–œä½“*</code>.

### bookdown

- ç« èŠ‚å»é™¤ç¼–å· ç« èŠ‚åé¢æ·»åŠ  {-}
- æ±‰è¯ï¼šç« èŠ‚æ ‡é¢˜æ±‰åŒ–ï¼Œhttps://bookdown.org/yihui/bookdown/internationalization.htmlã€‚é…ç½®æ–‡ä»¶`_bookdown.yml`

  ```
  language:
    ui:
  chapter_name: ["ç¬¬", "ç« "]
  ```


  >The chapter_name field can be either a character string to be prepended to chapter numbers in chapter titles (e.g., 'CHAPTER '), or an R function that takes the chapter number as the input and returns a string as the new chapter number (e.g., `!expr function(i) paste('Chapter', i))`. If it is a character vector of length 2, the chapter title prefix will be `paste0(chapter_name[1], i, chapter_name[2])`, where `i` is the chapter number. 

- å‡ºç°é”™è¯¯`Error in split_chapters(output, gitbook_page, number_sections, split_by,  :Automatically generated filenames contain duplicated ones: -`
  
  è¡¨ç¤ºç”±`split_by`è‡ªåŠ¨ç”Ÿæˆç« èŠ‚æ ‡é¢˜å‡ºç°é‡å¤æ ‡é¢˜è€Œå‡ºç°é”™è¯¯ã€‚ä¸­æ–‡æ ‡é¢˜ä¼šå‡ºç°è¿™ç§é”™è¯¯ï¼Œç« èŠ‚æ ‡é¢˜æ‰‹åŠ¨æ·»åŠ `{$ID}`å³å¯ï¼Œå‚è§[è¿™](https://d.cosx.org/d/420172-bookdown-split-chapters)å’Œ[è¿™](https://github.com/rstudio/bookdown/issues/520)
  
  å¦‚æœé—®é¢˜è¿˜å­˜åœ¨, è®¾ç½® `split_by`ä¸º`none`æˆ–`rmd`ï¼Œå‚è€ƒ[è¿™é‡Œ](https://github.com/rstudio/bookdown/issues/902).

##### github action éƒ¨ç½² bookdown åˆ° github page {-}

å‚è€ƒ https://github.com/r-lib/actions/blob/v2-branch/examples/bookdown.yaml.
ä½¿ç”¨[r-lib/actions/setup-r-dependencies@v2](https://github.com/r-lib/actions/tree/v2-branch/setup-r-dependencies)æ ¹æ® DESCRIPTION å®‰è£…ä¾èµ–çš„åŒ…;å¦‚æœè¦ç”Ÿæˆ PDF
æ–‡ä»¶å®‰è£… [TinyTex](https://github.com/r-lib/actions/tree/v2-branch/setup-tinytex).

```yaml
# Workflow derived from https://github.com/r-lib/actions/tree/master/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]

name: bookdown

jobs:
  bookdown:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2

      - uses: r-lib/actions/setup-pandoc@v1

      - uses: r-lib/actions/setup-r@v1
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-renv@v1
      
      # æ ¹æ® DESCRIPTION å®‰è£…ä¾èµ–çš„åŒ…
      # https://github.com/r-lib/actions/tree/v2-branch/setup-r-dependencies
      - uses: r-lib/actions/setup-r-dependencies@v2

      - name: Cache bookdown results
        uses: actions/cache@v2
        with:
          path: _bookdown_files
          key: bookdown-${{ hashFiles('**/*Rmd') }}
          restore-keys: bookdown-
      
      # å¦‚æœç”Ÿæˆ pdf å®‰è£…TinyTex    
      - name: Install TinyTeX
        uses: r-lib/actions/setup-tinytex@v1
        env:
          # install full prebuilt version
          TINYTEX_INSTALLER: TinyTeX
      
      - name: Build site
        run: |
          Rscript -e 'bookdown::render_book("index.Rmd", quiet = TRUE)'
          Rscript -e "bookdown::render_book('index.Rmd', 'bookdown::pdf_book')"

      - name: Deploy to GitHub pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: gh-pages
          folder: _book
```



### tinytex

- pkgdownç¼–è¯‘jssæ–‡æ¡£çš„æ—¶å€™å‡ºç°ï¼Œ`! LaTeX Error: File `ae.sty'not found.` è¯´æ˜ç¼ºå°‘aeåŒ…ï¼Œ

  ```{r eval=FALSE}
  tlmgr_search('ae.sty')
  # æç¤ºremote repository ç‰ˆæœ¬å¤ªæ—§ï¼Œ2018 < 2019,è¿™æ—¶å€™éœ€è¦å‡çº§texlive
  tinytex::reinstall_tinytex()

  tlmgr_search('ae.sty')
  # ae:
  #	    texmf-dist/tex/latex/ae/ae.sty

  #å®‰è£…å³å¯
  tlmgr_install('ae')
  ```
